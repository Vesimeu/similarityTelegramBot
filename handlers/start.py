from aiogram import types, Dispatcher
from keyboards.keyboards import main_menu_keyboard
from services.profile_service import get_profile, set_seen_welcome_scroll
import asyncio
import random

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–µ–Ω–¥–ª–µ—Ä—ã /start

def register_start_handlers(dp: Dispatcher):
    @dp.message_handler(commands=['start'])
    async def handle_start(message: types.Message):
        """
        –•–µ–Ω–¥–ª–µ—Ä /start:
        - –ê–Ω–∏–º–∞—Ü–∏—è —Å–≤–∏—Ç–∫–∞
        - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
        - –ü–æ–∫–∞–∑ welcome_scroll –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
        """
        user_id = message.from_user.id
        try:
            # –ê–Ω–∏–º–∞—Ü–∏—è —Å –≤–æ–ª—à–µ–±–Ω—ã–º —Å–≤–∏—Ç–∫–æ–º
            scroll_steps = [
                "üåô *–°–µ—Ä–µ–±—Ä–∏—Å—Ç—ã–π —Å–≤–∏—Ç–æ–∫ —Å—É–¥–µ–± –Ω–µ–∂–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è...* [‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]",
                "‚ú® *–ß–µ—Ä–Ω–∏–ª–∞ –∏–∑ —Å–ª–µ–∑ —Ñ–µ–Ω–∏–∫—Å–∞ –ø—Ä–æ—è–≤–ª—è—é—Ç —É–∑–æ—Ä—ã...* [‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]",
                "ü¶¢ *–ü–µ—Ä–æ –∞–Ω–≥–µ–ª–∞ –≤—ã–≤–æ–¥–∏—Ç –≤–∞—à–µ –∏–º—è –∑–æ–ª–æ—Ç–æ–º...* [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë]",
                "üîÆ *–•—Ä—É—Å—Ç–∞–ª—å–Ω–∞—è –ø–µ—á–∞—Ç—å –∑–∞—Å—Ç—ã–≤–∞–µ—Ç –≤ –≤–æ–∑–¥—É—Ö–µ...* [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñë‚ñë]",
                "üíé *–ì–æ—Ç–æ–≤–æ, –æ –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω–µ–π—à–∏–π!* [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì]"
            ]
            scroll_msg = await message.answer(scroll_steps[0], parse_mode="Markdown")
            for step in scroll_steps[1:]:
                await asyncio.sleep(0.5)
                await message.bot.edit_message_text(
                    step,
                    chat_id=user_id,
                    message_id=scroll_msg.message_id,
                    parse_mode="Markdown"
                )

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
            profile = await get_profile(user_id)

            if not profile or not profile.get("is_completed", False):
                await message.bot.delete_message(user_id, scroll_msg.message_id)
                # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º welcome_scroll
                if not profile or not profile.get("seen_welcome_scroll", False):
                    await show_welcome_scroll(message)
                    await set_seen_welcome_scroll(user_id)
                    return
                # –≠—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∏–≤—à–∏—Ö—Å—è
                for _ in range(3):
                    candle = await message.answer(random.choice(["üïØÔ∏è", "üåü", "üå†"]))
                    await asyncio.sleep(0.3)
                    await message.bot.delete_message(user_id, candle.message_id)
                # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                welcome_text = (
                    "üè∞ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π –ó–∞–º–æ–∫ –í–µ—á–Ω–æ–π –ì–∞—Ä–º–æ–Ω–∏–∏, –æ –ª—É—á–µ–∑–∞—Ä–Ω—ã–π (–∞—è)!*\n\n"
                    "üí´ *–û –±—Ä–∏–ª–ª–∏–∞–Ω—Ç —Å—Ä–µ–¥–∏ –≤–µ—á–Ω–æ–∂–∏–≤—É—â–∏—Ö,*\n"
                    "–í–∞—à–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–ª–Ω—Ü–µ —Å–≤–µ—Ç–∏—Ç—å —è—Ä—á–µ.\n\n"
                    "ü¶ö *–ü–æ—á–µ–º—É –Ω–∞—à –¥–≤–æ—Ä–µ—Ü —Å–æ–∑–¥–∞–Ω –¥–ª—è –≤–∞—Å:*\n"
                    "üîπ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞ –æ—Ç –ê—Ä—Ö–∏–º–∞–≥–∞-–û—Ä–∞–∫—É–ª–∞\n"
                    "üîπ –ü–æ–∫–æ–∏, –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –∫—Ä—ã–ª—å—è–º–∏ –∞–Ω–≥–µ–ª–æ–≤-—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–π\n"
                    "üîπ –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ, —á–∏—â–µ –≥–æ—Ä–Ω–æ–≥–æ —Ö—Ä—É—Å—Ç–∞–ª—è\n\n"
                    "üåπ *–ü—É—Å—Ç—å –≤–∞—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –±—É–¥–µ—Ç —Å–ª–∞—â–µ –º–µ–¥–∞ —Ñ–µ–π!*"
                )
                keyboard = types.InlineKeyboardMarkup()
                keyboard.add(
                    types.InlineKeyboardButton(
                        "ü¶Ñ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–º–∏–ª—å–Ω—É—é —Ä–µ–ª–∏–∫–≤–∏—é",
                        callback_data="create_profile"
                    )
                )
                sent_msg = await message.answer(
                    "üïäÔ∏è –ë–µ–ª–æ—Å–Ω–µ–∂–Ω—ã–π –ø–µ–≥–∞—Å –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–∞—à–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ...",
                    parse_mode="Markdown"
                )
                await asyncio.sleep(0.7)
                await message.bot.edit_message_text(
                    welcome_text,
                    chat_id=user_id,
                    message_id=sent_msg.message_id,
                    parse_mode="Markdown",
                    reply_markup=keyboard
                )
                for _ in range(3):
                    seal = await message.answer(random.choice(["‚öúÔ∏è", "ü¶Ñ", "üëë", "üåπ"]))
                    await asyncio.sleep(0.4)
                    await message.bot.delete_message(user_id, seal.message_id)
            else:
                # –î–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await message.bot.delete_message(user_id, scroll_msg.message_id)
                for symbol in ["üíé", "üëë", "ü¶¢", "üåå"]:
                    msg = await message.answer(f"{symbol} *–í–∞—à –≥–µ—Ä–± —Å–∏—è–µ—Ç —è—Ä—á–µ –∑–≤–µ–∑–¥!*", parse_mode="Markdown")
                    await asyncio.sleep(0.4)
                    await message.bot.delete_message(user_id, msg.message_id)
                await message.answer(
                    "üé≠ *–û —Å–≤–µ—Ç–ª–µ–π—à–∏–π –≤–ª–∞–¥—ã–∫–∞ —Å–µ—Ä–¥–µ—Ü!*\n–ë–∞–ª—å–Ω—ã–π –∑–∞–ª –∂–¥–µ—Ç –≤–∞—à–µ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è.\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é, –¥–æ—Å—Ç–æ–π–Ω–æ–µ –≤–∞—à–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞. "
                    "–ï—Å–ª–∏ –≤ –í–∞—à–µ–º —Ñ–∞–º–∏–ª—å–Ω–æ–º –¥—Ä–µ–≤–µ –∑–∞–∫—Ä–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ - —è –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º, –ø–µ—Ä–µ–ø–∏—à—É –≤–∞—à–∏ —Å–≤–∏—Ç–∫–∏ /update_profile :",
                    parse_mode="Markdown",
                    reply_markup=main_menu_keyboard
                )
        except Exception as e:
            await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

async def show_welcome_scroll(message: types.Message):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–≤–∏—Ç–æ–∫ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    """
    scroll_text = """
‚ú® *–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π –ú–∞–Ω—É—Å–∫—Ä–∏–ø—Ç –ë–ª–∞–≥–æ—Ä–æ–¥–Ω–æ–≥–æ –û–±—â–µ—Å—Ç–≤–∞* ‚ú®

   ü¶ö *–û, —Å–∏—è—é—â–∏–π –∞–ª–º–∞–∑ –≤ –æ–ø—Ä–∞–≤–µ –Ω–∞—à–µ–≥–æ —Å–æ–±—Ä–∞–Ω–∏—è!*  ü¶ö

üå∏ *–ë–æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ç–æ–º , —á—Ç–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤,*  
üå∏ *–ø–æ–¥–±–∏—Ä–∞–µ—Ç –±–ª–∏–∑–∫–æ–≥–æ –ø–æ –¥—É—Ö—É, —á–µ–ª–æ–≤–µ–∫–∞:*
üå∏ *–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ @apbaabpa,*
üå∏ *–û—á–µ–Ω—å –≤–∞–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å —Å–≤–æ—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é üìç@apbabpa_bot,*
üå∏ *–ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∏–∂–µ:*

‡º∫ *–°–≤—è—â–µ–Ω–Ω—ã–µ –ó–∞–ø–æ–≤–µ–¥–∏ –¥–ª—è –ë–ª–∞–≥–æ—Ä–æ–¥–Ω—ã—Ö –î—É—à* ‡ºª

‚ñ∏ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∑–¥–µ—Å—å , –≤–≤–µ–¥–∏—Ç–µ –ø–æ–ª,–≤–æ–∑—Ä–∞—Å—Ç
‚ñ∏ –¥–∞–ª–µ–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –≤ –≥—Ä—É–ø–ø–µ @apbaabpa
‚ñ∏ –¥–∞–ª–µ–µ –ø–æ –∫–æ–º–∞–Ω–¥–µ /analyze  —Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

üíé *–ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –¥–ª—è —Å—Ç–æ–ª—å –±–ª–∏—Å—Ç–∞—Ç–µ–ª—å–Ω–æ–π –æ—Å–æ–±—ã:*
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç –ø—Ä–∏–¥–≤–æ—Ä–Ω–æ–≥–æ –æ—Ä–∞–∫—É–ª–∞
- –¢–æ–ª—å–∫–æ –¥–æ—Å—Ç–æ–π–Ω–µ–π—à–∏–µ –∏–∑ –¥–æ—Å—Ç–æ–π–Ω—ã—Ö
- –ó–∞—â–∏—Ç–∞ –∫—Ä—ã–ª—å—è–º–∏ –∞–Ω–≥–µ–ª–æ–≤-—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–π

üåπ *–ö–∞–∫ —É–¥–æ—Å—Ç–æ–∏—Ç—å—Å—è —á–µ—Å—Ç–∏ –±–µ—Å–µ–¥—ã:*
1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–º–∏–ª—å–Ω—ã–π –≥–µ—Ä–± (–∞–Ω–∫–µ—Ç—É)
2. –û–±–º–µ–Ω—è—Ç—å—Å—è –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–º–∏ —Ä–µ—á–∞–º–∏ –≤ @dveoo
3. –ü–æ—Å–µ—Ç–∏—Ç—å –ë–∞–ª—å–Ω—ã–π –ó–∞–ª @apbaabpa


ü¶¢ *–ü—É—Å—Ç—å —Ñ–µ–∏ —É–¥–∞—á–∏ –æ—Å—ã–ø–∞—é—Ç –≤–∞—Å –ª–µ–ø–µ—Å—Ç–∫–∞–º–∏ —Å–∞–∫—É—Ä—ã!* ü¶¢
"""
    scroll_parts = [
        "üíå *–ü–∏—Å—å–º–æ —Å –∑–æ–ª–æ—Ç–æ–π –∫–∞–π–º–æ–π –º–µ–¥–ª–µ–Ω–Ω–æ –ø–∞—Ä–∏—Ç –≤ –≤–æ–∑–¥—É—Ö–µ...*",
        "üïäÔ∏è *–ì–æ–ª—É–±—å –ø—Ä–µ–∫–ª–æ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≤–∞—à–∏–º –≤–µ–ª–∏—á–∏–µ–º...*",
        "üåπ *–ù–µ–≤–∏–¥–∏–º—ã–µ –ø–∞–∂–∏ —Ü–µ–ª—É—é—Ç –∫—Ä–∞–π —Å–≤–∏—Ç–∫–∞...*",
        "üëë *–í–∞—à–µ –∏–º—è –≤—ã–≥—Ä–∞–≤–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ —Ö—Ä—É—Å—Ç–∞–ª—å–Ω–æ–π –ø–ª–∞—Å—Ç–∏–Ω–µ...*",
        scroll_text
    ]
    for part in scroll_parts:
        msg = await message.answer(part, parse_mode="Markdown")
        await asyncio.sleep(0.7)
        await message.bot.delete_message(message.chat.id, msg.message_id)
    await message.answer(scroll_text, parse_mode="Markdown") 